@page "/"
@using System.Data
@using Lapo.Mud.Services

<PageTitle>Home</PageTitle>

<MudButton @onclick="ScanAsync">Scan</MudButton>

@code
{
    [Inject] ConfigurationService ConfigurationService { get; set; } = null!;
    [Inject] CsvService CsvService { get; set; } = null!;
    [Inject] DatabaseService DatabaseService { get; set; } = null!;

    readonly Dictionary<string, DataTable> _lastScan = new();
    Dictionary<string, DataTable> _previousScan = new();
    
    List<DataRow> _acc = [];

    protected override Task OnInitializedAsync() => ScanAsync();

    async Task ScanAsync()
    {
        _lastScan.Clear();

        var tables = await ConfigurationService.ReadAsync<List<string>>("Tables") ?? [];
        foreach (var table in tables)
        {
            var rows = await DatabaseService.QueryAsync(table);
            _lastScan.Add(table, rows);
        }

        if (!_previousScan.Any())
        {
            _previousScan = new(_lastScan);
            _acc = _lastScan.SelectMany(x => x.Value.AsEnumerable()).ToList();
            return;
        }

        var diffResult = LoadDiff(_previousScan, _lastScan);
        CsvService.Write(diffResult);

        _previousScan = new(_lastScan);
        _acc = _lastScan.SelectMany(x => x.Value.AsEnumerable()).ToList();
    }

    static List<DataRow> LoadDiff(Dictionary<string, DataTable> previousScan, Dictionary<string, DataTable> lastScan)
    {
        var acc = new List<DataRow>();

        foreach (var table in lastScan.Keys)
        {
            if (!previousScan.TryGetValue(table, out var previous)) continue;

            previous.Columns.Add("Table", typeof(string));
            previous.Columns["Table"]?.SetOrdinal(0);
            previous.Columns.Add("Operation", typeof(string));
            previous.Columns["Operation"]?.SetOrdinal(1);

            var last = lastScan[table];
            last.Columns.Add("Table", typeof(string));
            last.Columns["Table"]?.SetOrdinal(0);
            last.Columns.Add("Operation", typeof(string));
            last.Columns["Operation"]?.SetOrdinal(0);

            var previousRows = previous.AsEnumerable().ToList();
            var lastRows = last.AsEnumerable().ToList();

            var previousDict = previousRows.ToDictionary(row => row["Id"]);
            var lastDict = lastRows.ToDictionary(row => row["Id"]);

            var added = lastRows.Where(row => !previousDict.ContainsKey(row["Id"])).ToList();
            foreach (var row in added) row["Operation"] = "ADDED";

            var removed = previousRows.Where(row => !lastDict.ContainsKey(row["Id"])).ToList();
            foreach (var row in removed) row["Operation"] = "DELETED";

            var updated = lastRows.Where(row => previousDict.ContainsKey(row["Id"]) && !row.ItemArray.SequenceEqual(previousDict[row["Id"]].ItemArray)).ToList();
            foreach (var row in updated) row["Operation"] = "UPDATED";
            
            acc.AddRange(added);
            acc.AddRange(removed);
            acc.AddRange(updated);
        }

        return acc.OrderBy(x => x["Table"]).ThenBy(x => x["Id"]).ToList();
    }
}
